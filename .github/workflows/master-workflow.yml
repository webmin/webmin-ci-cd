name: Master Workflow

on:
  workflow_call:
    inputs:
      build-type:
        required: true
        type: string
        description: 'Type of build: package or module'
      project-name:
        required: false
        type: string
        description: 'Name of the project to build (e.g. webmin, usermin, virtualmin-gpl; if not specified, the default is always webmin and usermin)'
      is-release:
        required: false
        type: boolean
        default: false
        description: 'Whether this is a release or just a testing build'
      is-prerelease:
        required: false
        type: boolean
        default: false
        description: 'Whether this is a final release or a pre-release build'
      is-checkout:
        description: 'Whether to checkout the code or not'
        required: false
        type: boolean
        default: false
      module-build-type:
        required: false
        type: string
        default: 'core'
        description: 'Build type for packages (e.g. full, core, minimal)'
      rebuild-all-modules:
        required: false
        type: boolean
        default: false
        description: 'Rebuild all product modules by skipping incremental build checks'
      legacy-rpm-names:
        required: false
        type: boolean
        default: false
        description: 'Whether to use old RPM prefixes like wbm-, wbt-, etc., in module package names'
    secrets:
      DEV_IP_ADDR:
        required: true
      DEV_IP_KNOWN_HOSTS:
        required: false
      DEV_UPLOAD_SSH_USER:
        required: true
      DEV_UPLOAD_SSH_DIR:
        required: true
      DEV_SSH_PRV_KEY:
        required: true
      PRERELEASE_UPLOAD_SSH_DIR:
        required: true
      ALL_GPG_PH2:
        required: true
      DEV_CHILD_GITHUB_TOKEN:
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'push' || !contains(github.event.head_commit.message, '[no-build]') }}
    env:
      TZ: Europe/Nicosia
      CI_CD_STABLE_BASE: https://github.com/webmin/webmin-ci-cd/releases/latest/download
      CI_CD_UNSTABLE_BASE: https://raw.githubusercontent.com/webmin/webmin-ci-cd/main/build
    steps:
      - name: Checkout code
        if: ${{ inputs.is-checkout }}
        uses: actions/checkout@v4
        with:
          path: actions-checkout
          fetch-depth: 1

      - uses: awalsh128/cache-apt-pkgs-action@latest
        with: 
          packages: git tar gzip openssl curl openssh-client rpm perl libjson-pp-perl libdigest-sha-perl liblist-moreutils-perl libencode-detect-perl zstd
          version: 1.0

      - name: Fetch dependencies
        run: |
          set -euo pipefail
          if [ "${{ inputs.is-release }}" = "true" ] && [ "${{ inputs.is-prerelease }}" != "true" ]; then
            base="${CI_CD_STABLE_BASE}"
            echo "Using stable build scripts from: $base"
          else
            base="${CI_CD_UNSTABLE_BASE}"
            echo "Using unstable build scripts from: $base"
          fi
          echo "BUILD_BOOTSTRAP_URL=$base" >> "$GITHUB_ENV"
          curl -fsSLo bootstrap.bash "$base/bootstrap.bash"
          chmod +x bootstrap.bash

      - name: Set timezone
        run: sudo timedatectl set-timezone ${{ env.TZ }}

      - name: Build and upload
        env:
          CLOUD__BUILD_RUN_ATTEMPT: ${{ github.run_attempt }}
          CLOUD__IP_ADDR: ${{ secrets.DEV_IP_ADDR }}
          CLOUD__IP_KNOWN_HOSTS: ${{ secrets.DEV_IP_KNOWN_HOSTS }}
          CLOUD__UPLOAD_SSH_USER: ${{ secrets.DEV_UPLOAD_SSH_USER }}
          CLOUD__UPLOAD_SSH_DIR: ${{ inputs.is-release && secrets.PRERELEASE_UPLOAD_SSH_DIR || secrets.DEV_UPLOAD_SSH_DIR }}
          CLOUD__SSH_PRV_KEY: ${{ secrets.DEV_SSH_PRV_KEY }}
          CLOUD__GPG_PH2: ${{ secrets.ALL_GPG_PH2 }}
          CLOUD__GH_TOKEN: ${{ secrets.DEV_CHILD_GITHUB_TOKEN }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message || '' }}
        run: |-
          # Set build mode
          build_args=()
          if [ "${{ inputs.is-release }}" = "true" ]; then
              build_args=(--release)
              if [ "${{ inputs.is-prerelease }}" = "true" ]; then
                  build_args+=(--prerelease)
              fi
          else
              build_args=(--testing)
          fi

          # Set output mode
          [[ "$RUNNER_DEBUG" == "1" ]] && build_args+=(--verbose)

          # Build excluded modules if it is not a full build
          if [ "${{ inputs.module-build-type }}" != "full" ]; then
              build_args+=(--build-type="${{ inputs.module-build-type }}")
          fi

          # Add no commit check if enabled to re-build all non-core modules with
          # a new version
          should_force_rebuild=false
          [ "${{ inputs.rebuild-all-modules }}" = "true" ] && should_force_rebuild=true
          [ "${{ github.ref_type }}" = "tag" ] && should_force_rebuild=true
          [ "${{ github.event_name }}" = "release" ] && should_force_rebuild=true
          if [ "${{ github.event_name }}" = "push" ]; then
            commit_msg="$COMMIT_MESSAGE"
            [[ "$commit_msg" == *"[rebuild-all-modules]"* ]] && should_force_rebuild=true
            [[ "$commit_msg" == *"version bump"* ]] && should_force_rebuild=true
            [[ "$commit_msg" =~ ^v?[0-9]+\.[0-9]+(\.[0-9]+)*$ ]] && should_force_rebuild=true
          fi
          [ "$should_force_rebuild" = "true" ] && build_args+=(--rebuild-all-modules)

          # Use legacy RPM names if enabled, otherwise use new
          [ "${{ inputs.legacy-rpm-names }}" = "false" ] && \
            build_args+=(--no-wbm-prefix)

          # Bootstrap to prepare the environment
          bash bootstrap.bash "${build_args[@]}"

          # Build the product
          if [ "${{ inputs.build-type }}" = "package" ]; then
            bash build-product-deb.bash ${{ inputs.project-name }} "${build_args[@]}"
            bash build-product-rpm.bash ${{ inputs.project-name }} "${build_args[@]}"
          # Build the module
          else
            bash build-module-deb.bash ${{ inputs.project-name }} "${build_args[@]}"
            bash build-module-rpm.bash ${{ inputs.project-name }} "${build_args[@]}"
          fi
